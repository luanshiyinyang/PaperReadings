# MLT解读

## 简介

在很多方法都在检测上做文章的时候，能看到MLT这样一篇在Public赛道做研究并取得相当好的效果的文章是很难得的，就像论文的标题一样，它直面了MOT目前针对二维图像的一个痛点，那就是遮挡问题尤其是密集人群场景下的遮挡问题。论文提出了一种基于图的near-online跟踪方法，该方法设计了一种检测multiplexing（多路复用）技术并设计了一种多标签图（multiplex labeling graph，MLG）模型，**这种一个检测框可以拥有多个ID的复用思路是本文最大的创新点之一**。此外，这篇文章还引入LSTM来对构建的MLG进行优化，实验证明其在多个数据集上达到了SOTA表现，在MOT Challenge公榜（public赛道，不使用私有检测，将研究重点放在跟踪问题上）成为了新的SOTA，最新的MOT17的全榜结果如下图，其实可以看到，在整个榜单上，它MOTA距离第一不算太多，IDF1和Frag这些比较依赖跟踪性能而不是检测性能的指标上相对于其他方法都是当之无愧的SOTA。

- 论文标题

    Multiplex Labeling Graph for Near-Online Tracking in Crowded Scenes
- 论文地址

    https://ieeexplore.ieee.org/document/9098857

![截至2021年1月](./assets/benchmark.png)

## 介绍

多目标跟踪（multiple object tracking，MOT）是计算机视觉领域一个颇受关注的话题，其对于监控分析、远程控制等工业场景应用广泛。不同于车辆跟踪，只发生在固定的车道约束内，行人的移动往往是没什么约束的。因此行人跟踪会更加困难。TBD（tracking by detection）范式是目前MOT领域最常用的框架，它的思路分为两步，先是将每一帧上的目标检测出来，然后通过一定的度量指标对帧间的目标进行数据关联。很多基于TBD范式的MOT方法在人群稀疏的场景下效果不错，然而人群密集的场景下仍旧缺少比较高效的方法。

![](./assets/3states.png)

密集场景下跟踪的难点其实在于行人频繁的互动遮挡，为了分析行人之间的交互问题，论文中分析并定义了三种交互模式。gathering；side by side；dispersion。含义就是字面意思，其他复杂的交互都可以由着三种基本模式组合而成，如上图所示，当行人并排走的时候，遮挡也就发生了，这给跟踪带来了严重的干扰。

当然，当多个行人发生严重的遮挡时，检测器其实很难得到多个结果，因为他们离得太近了，因此检测器只会给出一个包裹整个范围的检测框，如下图所示，先忽略其两个id的双色框，其实这个检测框（下文简称bbox）包含两个目标，只是其中一个被遮挡了。**这种单框输出是检测器的选择，因为对于目标检测这个不需要考虑时序信息的空间任务而言，那么“所见即所得”，那个位置当然只有一个可见目标。然而，对于跟踪这个需要时序信息的任务而言，两个目标空间上合二为一会在关联时造成和现有轨迹的一对多匹配问题。** 因此，现有的跟踪器通常有一个基本假设，那就是一个bbox就对应一个目标，从而一对多的关联任务被当作冲突处理问题对待，多个轨迹只有一个被保留，其他的都被移除（这样，由于大部分MOT方法都不会立即销毁轨迹，短暂的消失之后还会匹配回来）。

![](./assets/onebox.png)

上述这种假设单框对单目标的假设存在一个严重的问题，如本节第一张图的b所示，两个行人不是图a这种轨迹的短暂交互，而是聚集之后一直并肩移动，其中一个人一直处于另一个人的遮挡下，且他们长时间没有分离开。这种情况下，检测器当然只会反馈一个bbox，这个bbox会被赋予一个轨迹ID，而另一个轨迹就彻底消失了。为了生成两个完整的轨迹，论文引入了一种检测复用方法来解决这个一对多关联问题并提出多标签图跟踪模型（MLG）。

在MLG模型中，图中的任意一个节点可以同时表示多个目标，也就是被赋予多个ID。同时，LSTM结构用来评估检测框的相似度以进行数据关联，基于LSTM用于运动和外观建模的模型结构分别为MAN和AAN。

## MLG

这一节先来介绍一下MLG这个基于图的跟踪模型是如何实现的。首先，不同于其他的基于图的方法，论文从一个新的角度重新审视了交互过程中检测冲突的问题。大部分MOT方法都基于一个基本假设，每个bbox都表示现实世界地一个目标，实际上这在三维空间中是成立的，但是三维压缩到二维图像中就不一定了，因此，在二维空间中，多个轨迹共享一个bbox的情况是有理由的。

检测器生成的bbox作为基础节点来表示目标，$D=\left\{d_{1}, d_{2}, d_{3}, \ldots, d_{n}\right\}$表示视频中所有的检测结果集合，对每个$d_i$，它的宽高为$(w_i,h_i)$，位置为$(x_i,y_i)$，$c_i$表示置信度，此外，$\left(a_{i, 1}, a_{i, 2}, \ldots, a_{i, 1536}\right)$一个1536维CNN特征向量用来描述$d_i$的外观信息，这个向量由在Market1501上训练的PCB网络产生。

### 图的构建

假定第t帧之前的轨迹已经生成了，MLG是一个滑窗内的有向图$G=\{V ; E\}$，如下图所示，该图沿着$t-1$帧到$t+2$帧构建，此时滑窗的窗口为3（实际上算法采用的窗口大小为20时效果较好，这部分后面说明）。

![](./assets/MLG.png)

考虑到真实世界的情况和计算效率，在所有检测之间建边是没有必要的，而且，由于检测框已经被NMS处理，因此一帧内不存在一个目标有多个bbox的情况。因此，只需要链接不同帧的bbox即可构成轨迹。将滑窗范围内所有的检测bbox形成的节点组成的集合称为Node Set，将有关联的两个不同的节点之间的有向边组成的集合称为Edge Set，显然任意有向边的出发点应该在结束点之前的帧上。示例如上图所示，**显然，这个边的形成是可以跨帧存在的，这不同于二分图匹配，而是一种滑窗内部的有约束全图匹配。**

通过上面的分析，其实可以看到，图$G$其实可以表示为一个严格的上三角矩阵如下，其中的上三角元素$E_{i, j}$是一个$n_i\times n_j$的矩阵用来描述第$i$帧的$n_i$个检测框和第$j$帧的$n_j$个检测框之间的关联。下三角部分之所以都是$0$矩阵是因为有向边只会在时间线上从前向后存在。

$$
\left[\begin{array}{cccc}
0 & E_{t-1, t} & E_{t-1, t+1} & E_{t-1, t+2} \\
0 & 0 & E_{t, t+1} & E_{t, t+2} \\
0 & 0 & 0 & E_{t+1, t+2} \\
0 & 0 & 0 & 0
\end{array}\right]
$$

漂移（Drift）在目标跟踪中一直是一个问题，随着目标的外观变化，轨迹逐渐偏离GT是很常见的现象。论文中通过设置较高的阈值来保证通过边关联的检测来自同一个目标，阈值的确定基于目标的位置关系和目标的外观相似度。具体如下式，其中$t_{ij}$是阈值指示器用来决定两个bbox是否关联到一起。两个bbox$d_i$和$d_j$之间当前仅当$t_{ij}=1$的时候构建边。阈值由两部分组成：**运动**和**外观**，$\tau_{m}$是一个为运动信息设置的自适应阈值，它设置为两个bbox的最大宽度$\max \left(w_{i}, w_{j}\right)$；另一个阈值被设置用来描述外观相似度，采用$a_i$和$a_j$的余弦距离作为指标，$\tau_{a}$设置为$0.9$以避免漂移（注意，这里的$a_i$表示检测框$d_i$的外观向量）。

$$
\begin{aligned}
t_{i j} &=t_{m, i j} \cdot t_{a, i j} \\
t_{m, i j} &=\left\{\begin{array}{ll}
0, & \left\|\left(x_{i}, y_{i}\right),\left(x_{j}, y_{j}\right)\right\|_{2}>\tau_{m} \\
1, & \left\|\left(x_{i}, y_{i}\right),\left(x_{j}, y_{j}\right)\right\|_{2} \leq \tau_{m}
\end{array}\right.\\
t_{a, i j} &=\left\{\begin{array}{ll}
0, & \cos \left(a_{i}, a_{j}\right)<\tau_{a} \\
1, & \cos \left(a_{i}, a_{j}\right) \geq \tau_{a}
\end{array}\right.
\end{aligned}
$$

## 多标签优化


## 总结

抛开速度不谈，MLT其实是一个非常具有创新性的MOT方法

